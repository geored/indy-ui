FROM georgy/maven:3.5.4_8u191-jdk

ENV INDY_VERSION 1.7.4-SNAPSHOT
ENV INDY_WORKINGDIR /opt/indy
ENV INDY_LAUNCHER_TYPE complete
ENV INDY_MAVEN_SKIPTESTS true
ENV INDY_MAVEN_COMMAND_CLEAN clean
ENV INDY_MAVEN_COMMAND package
ENV INDY_BUILD_TARGETDIR $INDY_WORKDIR/deployments/launcher/target

ADD . $INDY_WORKINGDIR

RUN cd $INDY_WORKINGDIR && \
    mvn $INDY_MAVEN_COMMAND_CLEAN -DskipTests=$INDY_MAVEN_SKIPTESTS $INDY_MAVEN_COMMAND && \
    cd $INDY_BUILD_TARGETDIR && \
    tar -xvf indy-launcher-${INDY_VERSION}-$INDY_LAUNCHER_TYPE.tar.gz

WORKDIR $INDY_BUILD_TARGETDIR/indy

RUN chgrp -R 0 $INDY_WORKDIR && \
    chmod -R g=u $INDY_WORKDIR && \
    cd $INDY_BUILD_TARGETDIR/indy

ENV JAVA_MAJOR_VERSION 8
ENV JAVA_APP_DIR $INDY_BUILD_TARGETDIR/indy
ENV JAVA_LIB_DIR $INDY_BUILD_TARGETDIR/indy/lib
ENV JAVA_OPTIONS "-Dindy.home=. -Dorg.jboss.logging.provider=sl4j -Dhttps.protocols=TLSv1,TLSv1.1,TLSv1.2"
ENV JAVA_CLASSPATH ${JAVA_LIB_DIR}/indy-embedder-$INDY_VERSION.jar
ENV JAVA_CLASSPATH $JAVA_CLASSPATH:$JAVA_LIB_DIR/thirdparty/*
ENV JAVA_MAIN_CLASS org.commonjava.indy.boot.jaxrs.JaxRsBooter

EXPOSE 8080

CMD java -cp $JAVA_CLASSPATH $JAVA_OPTIONS $JAVA_MAIN_CLASS